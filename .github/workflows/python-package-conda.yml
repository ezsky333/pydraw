name: Daily Request

on:
  push:               # åœ¨æ¨é€ä»£ç æ—¶è§¦å‘
    branches:
      - main         # æ›¿æ¢ä¸ºä½ çš„ç›®æ ‡åˆ†æ”¯ï¼Œé€šå¸¸æ˜¯ main æˆ– master
  schedule:
    - cron: '50 0 * * *' # æ¯å¤©00:00 (UTC) æ‰§è¡Œ

jobs:
  send_request:
    runs-on: ubuntu-latest

    steps:
      - name: Send POST request for ä¸€æ–©
        id: request_1
        run: |
          response=$(curl --location --request POST 'https://edu.definesys.cn/edu-api/forumSign/sign' \
          --header "Token: ${{ secrets.FORUM_TOKEN }}")
          echo "::set-output name=response::$response"
      - name: Send POST request for æ—è€å¸ˆ
        id: request_lin
        run: |
          response=$(curl --location --request POST 'https://edu.definesys.cn/edu-api/forumSign/sign' \
          --header "Token: ${{ secrets.FORUM_TOKEN_LIN }}")
          echo "::set-output name=response::$response"
      - name: Send POST request for ç‹è€å¸ˆ
        id: request_wang
        run: |
          response=$(curl --location --request POST 'https://edu.definesys.cn/edu-api/forumSign/sign' \
          --header "Token: ${{ secrets.FORUM_TOKEN_WANG }}")
          echo "::set-output name=response::$response"

      - name: Evaluate responses and send consolidated message
        run: |
          format_response() {
            local response=$1
            local name=$2
            local code=$(echo $response | jq -r '.code')
            local message=$(echo $response | jq -r '.message')
            if [[ $code == "ok" ]]; then
              echo "**$nameï¼š** ç­¾åˆ°æˆåŠŸï¼ğŸ‰"
            else
              echo "**$nameï¼š** ç­¾åˆ°å¤±è´¥ï¼š$message âŒ"
            fi
          }

          response_1='${{ steps.request_1.outputs.response }}'
          response_lin='${{ steps.request_lin.outputs.response }}'
          response_wang='${{ steps.request_wang.outputs.response }}'

          message_1=$(format_response "$response_1" "ä¸€æ–©")
          message_lin=$(format_response "$response_lin" ${{ secrets.FORUM_NAME_LIN }})
          message_wang=$(format_response "$response_wang" ${{ secrets.FORUM_NAME_WANG }})

          final_message="$message_1\n$message_lin\n$message_wang"

          curl --location --request POST 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${{ secrets.WECHAT_WORK_WEBHOOK_KEY }}' \
          --header 'Content-Type: application/json' \
          --data-raw "{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"$final_message\"}}"
