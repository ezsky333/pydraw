name: Daily Request

on:
  push:               # 在推送代码时触发
    branches:
      - main         # 替换为你的目标分支，通常是 main 或 master
  schedule:
    - cron: '50 0 * * *' # 每天00:00 (UTC) 执行

jobs:
  send_request:
    runs-on: ubuntu-latest

    steps:
      - name: Send POST request for 一斩
        id: request_1
        run: |
          response=$(curl --location --request POST 'https://edu.definesys.cn/edu-api/forumSign/sign' \
          --header "Token: ${{ secrets.FORUM_TOKEN }}")
          echo "::set-output name=response::$response"
      - name: Send POST request for 林老师
        id: request_lin
        run: |
          response=$(curl --location --request POST 'https://edu.definesys.cn/edu-api/forumSign/sign' \
          --header "Token: ${{ secrets.FORUM_TOKEN_LIN }}")
          echo "::set-output name=response::$response"
      - name: Send POST request for 王老师
        id: request_wang
        run: |
          response=$(curl --location --request POST 'https://edu.definesys.cn/edu-api/forumSign/sign' \
          --header "Token: ${{ secrets.FORUM_TOKEN_WANG }}")
          echo "::set-output name=response::$response"

      - name: Evaluate responses and send consolidated message
        run: |
          format_response() {
            local response=$1
            local name=$2
            local code=$(echo $response | jq -r '.code')
            local message=$(echo $response | jq -r '.message')
            if [[ $code == "ok" ]]; then
              echo "**$name：** 签到成功！🎉"
            else
              echo "**$name：** 签到失败：$message ❌"
            fi
          }

          response_1='${{ steps.request_1.outputs.response }}'
          response_lin='${{ steps.request_lin.outputs.response }}'
          response_wang='${{ steps.request_wang.outputs.response }}'

          message_1=$(format_response "$response_1" "一斩")
          message_lin=$(format_response "$response_lin" ${{ secrets.FORUM_NAME_LIN }})
          message_wang=$(format_response "$response_wang" ${{ secrets.FORUM_NAME_WANG }})

          final_message="$message_1\n$message_lin\n$message_wang"

          curl --location --request POST 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${{ secrets.WECHAT_WORK_WEBHOOK_KEY }}' \
          --header 'Content-Type: application/json' \
          --data-raw "{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"$final_message\"}}"
